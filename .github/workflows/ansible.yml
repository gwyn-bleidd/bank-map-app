name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  run-playbooks:
    runs-on: ubuntu-latest
    steps: 
      - uses: actions/checkout@v3
        with:
          submodules: true
      
      - name: before script
        shell: bash
        run: |
          apt-get update -y && apt-get install openssh-client -y 
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_KEY }}" | tr -d '\r' | ssh-add -
          mkdir -p ~/.ssh
          touch ~/.ssh/config
          touch ~/.ssh/known_hosts
          touch ~/.ssh/id_rsa
          echo -e "${{ secrets.SSH_KEY }}" | tr -d '\r' > /home/runner/.ssh/id_rsa
          chmod -R 400 ~/.ssh
          chmod 700 ~/.ssh/id_rsa
      #     ssh-add
      # - name: Setup SSH 
      #   shell: bash
      #   run: |
      #     eval `ssh-agent -s`
      #     mkdir -p /home/runner/.ssh/
      #     touch /home/runner/.ssh/id_rsa
      #     echo -e "${{ secrets.SSH_KEY }}" > /home/runner/.ssh/id_rsa
      #     chmod 700 /home/runner/.ssh/id_rsa
      #     ssh-add
      - name: Run ansible script
        shell: bash 
        run: |
          service ssh status
          cd infra/ansible
          ansible-playbook -vvv --private-key /home/runner/.ssh/id_rsa -u ${{secrets.ANSIBLE_DEPLOY_USER }} -i hs.yml deploy.yml
